{
  "version": 3,
  "sources": ["../src/speech/recognizer.ts"],
  "sourcesContent": ["// Lightweight wrapper around the Web Speech API for the teleprompter\r\n// Exposes a simple Recognizer class that emits transcripts to a callback.\r\nexport type RecognizerOptions = {\r\n  lang?: string;\r\n  interimIntervalMs?: number; // how often to forward interim results (debounce)\r\n  maxAlternatives?: number;\r\n};\r\n\r\ntype ResultCallback = (_transcript: string, _isFinal: boolean) => void;\r\n\r\nexport class Recognizer {\r\n  private recog: any | null = null;\r\n  private cb: ResultCallback | null = null;\r\n  private opts: RecognizerOptions;\r\n  private _lastInterimAt = 0;\r\n  private shouldRun = false;\r\n  private restartTimer: ReturnType<typeof setTimeout> | null = null;\r\n\r\n  constructor(opts: RecognizerOptions = {}) {\r\n    this.opts = Object.assign({ lang: 'en-US', interimIntervalMs: 150, maxAlternatives: 2 }, opts);\r\n  }\r\n\r\n  private logSpeechError(ev: any) {\r\n    try {\r\n      console.log('[speech] error', ev);\r\n    } catch {}\r\n  }\r\n\r\n  private clearRestartTimer() {\r\n    if (this.restartTimer !== null) {\r\n      clearTimeout(this.restartTimer);\r\n      this.restartTimer = null;\r\n    }\r\n  }\r\n\r\n  private scheduleRestart(delayMs: number, opts: { stopFirst?: boolean } = {}) {\r\n    if (!this.shouldRun) return;\r\n    if (!this.recog || typeof this.recog.start !== 'function') return;\r\n    const recognition = this.recog;\r\n    this.restartTimer = setTimeout(() => {\r\n      this.restartTimer = null;\r\n      if (!this.shouldRun) return;\r\n      if (opts.stopFirst) {\r\n        try { recognition.stop?.(); } catch {}\r\n      }\r\n      try {\r\n        recognition.start?.();\r\n      } catch (err) {\r\n        try { console.warn('[speech] restart failed', err); } catch {}\r\n      }\r\n    }, delayMs);\r\n  }\r\n\r\n  available(): boolean {\r\n    return Boolean((globalThis as any).SpeechRecognition || (globalThis as any).webkitSpeechRecognition);\r\n  }\r\n\r\n  start(cb: ResultCallback) {\r\n    this.cb = cb;\r\n    const SR = (globalThis as any).SpeechRecognition || (globalThis as any).webkitSpeechRecognition;\r\n    if (!SR) throw new Error('SpeechRecognition not available');\r\n    try {\r\n      this.recog = new SR();\r\n      try {\r\n        if (typeof window !== 'undefined') {\r\n          (window as any).recog = this.recog;\r\n        }\r\n      } catch {}\r\n      this.shouldRun = true;\r\n      this.clearRestartTimer();\r\n      this.recog.continuous = true;\r\n      this.recog.interimResults = true;\r\n      this.recog.lang = this.opts.lang;\r\n      try {\r\n        this.recog.maxAlternatives = Math.max(2, this.recog.maxAlternatives || 0, this.opts.maxAlternatives || 2);\r\n      } catch {}\r\n\r\n      this.recog.onstart = () => {};\r\n      this.recog.onerror = (ev: any) => {\r\n        this.logSpeechError(ev);\r\n        if (!ev || ev.error !== 'network') return;\r\n        if (!this.shouldRun) return;\r\n        this.clearRestartTimer();\r\n        this.scheduleRestart(800, { stopFirst: true });\r\n      };\r\n      this.recog.onend = () => {\r\n        if (!this.shouldRun) return;\r\n        if (this.restartTimer !== null) return;\r\n        this.scheduleRestart(500);\r\n      };\r\n\r\n      this.recog.onresult = (e: any) => {\r\n        let interim = '';\r\n        let finals = '';\r\n        for (let i = e.resultIndex; i < e.results.length; i++) {\r\n          const r = e.results[i];\r\n          if (r.isFinal) finals += (r[0]?.transcript || '') + ' ';\r\n          else interim += (r[0]?.transcript || '') + ' ';\r\n        }\r\n        if (finals && this.cb) this.cb(finals.trim(), true);\r\n        const now = performance.now();\r\n        if (interim && now - this._lastInterimAt > (this.opts.interimIntervalMs || 150)) {\r\n          this._lastInterimAt = now;\r\n          if (this.cb) this.cb(interim.trim(), false);\r\n        }\r\n      };\r\n\r\n      try {\r\n        this.recog.start();\r\n      } catch (e) {\r\n        // Chrome may throw if start is requested too soon; rely on onerror/onend.\r\n        this.logSpeechError(e);\r\n      }\r\n    } catch (err) {\r\n      this.shouldRun = false;\r\n      this.clearRestartTimer();\r\n      this.recog = null;\r\n      throw err;\r\n    }\r\n  }\r\n\r\n  stop() {\r\n    try {\r\n      this.shouldRun = false;\r\n      this.clearRestartTimer();\r\n      if (this.recog) {\r\n        try { this.recog.stop(); } catch {}\r\n      }\r\n    } finally {\r\n      this.recog = null;\r\n      this.cb = null;\r\n    }\r\n  }\r\n}\r\n\r\n// Export a convenience factory used by a loader or runtime shim\r\nexport function createRecognizer(opts?: RecognizerOptions) {\r\n  return new Recognizer(opts);\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
