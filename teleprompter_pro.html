<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Anvil v1.7.6</title>
  <meta name="description" content="Anvil Teleprompter Pro — speech-synced scrolling with OBS integration. Run scripts, mark takes, and auto-record scenes." />
  <!-- Prefer color-scheme-aware theme colors; drop deprecated msapplication-navbutton-color -->
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0b0f19" />
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff" />
  <!-- Fallback for browsers that ignore media attribute on theme-color -->
  <meta name="theme-color" content="#0b0f19" />
  <!-- Enable standalone display mode for iOS when added to Home Screen (needed for status-bar-style below) -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <!-- Removed: <meta name="msapplication-navbutton-color" ...> (obsolete) -->
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="color-scheme" content="dark light" />

  <!-- Canonical helps SEO (avoid /index.html vs /) -->
  <link rel="canonical" href="https://example.com/teleprompter/" />

  <script>
    try { window.APP_VERSION = '1.7.6'; } catch (err) { /* no-op */ }
  </script>

  <!-- Favicons -->
  <!-- Site icon (PNG). Place the provided anvil/mic image at assets/anvil-favicon.png -->
  <link rel="icon" type="image/png" sizes="512x512" href="assets/anvil-favicon.png">
  <!-- iOS home screen icon (falls back to same PNG) -->
  <link rel="apple-touch-icon" href="assets/anvil-favicon.png">

  <!-- Resource Hints (warm up WS host + any assets host; keep http for dev) -->
  <link rel="preconnect" href="http://192.168.1.200:4455" crossorigin>
  <!-- If you serve fonts or CDN assets, add preconnects for those origins, too -->

  <!-- Load CSS in a simple, reliable way -->
  <link rel="stylesheet" href="teleprompter_pro.css">

  <!-- Preload Mammoth so DOCX importer always sees window.mammoth -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

  <!-- TS bundle preload + entry (single brain) -->
  <link id="tp-dist-preload" rel="modulepreload" href="./dist/index.js?v=dev" as="script">
  <script>
    (function(){
      try {
        var dist = './dist/index.js';
        var addv = (window).__TP_ADDV;
        if (typeof addv === 'function') dist = addv(dist);
        else if (addv) dist = dist + '?v=' + encodeURIComponent(addv);
        else dist = dist + '?v=dev';
        var preload = document.getElementById('tp-dist-preload');
        if (preload) preload.href = dist;
        var entry = document.getElementById('tp-dist-entry');
        if (entry) entry.src = dist;
      } catch (err) {
        try { console.warn('[preload] using default dist path', err); } catch {}
      }
    })();
  </script>
  <script id="tp-dist-entry" type="module" src="./dist/index.js?v=dev"></script>

  <!-- Dev flag → add .tp-dev class early so CSS can key off it -->
  <script>
    (function(){
      try {
        var Q=new URLSearchParams(location.search);
        var DEV = Q.has('dev') || (function(){try{return localStorage.getItem('tp_dev_mode')==='1'}catch(e){return false}})() || (location.hash||'').indexOf('dev')!==-1;
        var DEV1 = (Q.get('dev')==='1') || (Q.get('dev1')==='1') || Q.has('dev1') || ((location.hash||'').indexOf('dev1')!==-1);
        if (DEV) document.documentElement.classList.add('tp-dev');
        if (DEV1) document.documentElement.classList.add('dev1');
        window.__TP_DEV = DEV;
        window.__TP_DEV1 = DEV1;
      } catch (e) {}
    })();
  </script>

  <!-- Safe requestScroll polyfill (kept) -->
  <script>
    (function(){
      try {
        if (!window.requestScroll) {
          window.requestScroll = function(arg){
            try {
              var top = (typeof arg==='object')?Number(arg&&arg.top):Number(arg);
              if (!isFinite(top)) top = 0;
              var behavior = (typeof arg==='object'&&arg&&arg.behavior)?String(arg.behavior):'smooth';
              if (typeof window.scrollTo==='function') window.scrollTo({top,behavior});
              else (document.scrollingElement||document.documentElement||document.body).scrollTop = top;
            } catch (e) {}
          };
        }
      } catch (e) {}
    })();
  </script>

  <!-- Mammoth loader shim (legacy-safe): ensures window.ensureMammoth exists -->
  <script>
    (function(){
      try {
        if (!('ensureMammoth' in window)) {
          (window).ensureMammoth = function(){
            return new Promise(function(resolve){
              try {
                if ((window).mammoth) { resolve((window).mammoth); return; }
                var s = document.createElement('script');
                s.src = 'https://unpkg.com/mammoth/mammoth.browser.min.js';
                s.async = true;
                s.onload = function(){ try { resolve((window).mammoth || null); } catch(e){ resolve(null); } };
                s.onerror = function(){ resolve(null); };
                document.head.appendChild(s);
              } catch (e) { resolve(null); }
            });
          };
        }
      } catch (e) {}
    })();
  </script>

  <!-- Third-party: mammoth will be loaded lazily by ui/upload.js when needed -->

  <!-- (helpers loaded from modules in dev via src/index.js) -->

  
  

  <!-- Early UI sanitizer: remove duplicate settings panels injected by older builds/extensions -->
  <script src="ui-sanitize.js"></script>

  <!-- Single loader above; no additional booters here. -->

  <!-- Module runtime controls the page; legacy direct scripts removed to avoid double wiring -->

  <!-- Inline critical CSS (small, ~2KB): topbar, chips, basic app grid and first-screen editor/viewer -->
  <style>
    :root{--bg:#0b0f19;--fg:#e6eef8;--muted:#9fb4c9;--chip-bg:rgba(255,255,255,0.03)}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .topbar{display:flex;align-items:center;gap:8px;padding:8px 12px;height:48px;box-sizing:border-box;border-bottom:1px solid rgba(255,255,255,0.02);background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent)}
    .topbar strong{font-weight:600;margin-right:6px}
    .chip{display:inline-block;padding:4px 8px;border-radius:8px;background:var(--chip-bg);color:var(--fg);font-size:13px}
    .inl-1{margin-left:auto}
    .app{display:grid;grid-template-columns:320px 1fr;gap:12px;padding:12px;box-sizing:border-box}
    .panel{background:transparent;color:var(--muted);max-height:calc(100vh - 92px);overflow:auto}
    .viewer{background:transparent;padding:6px;min-height:calc(100vh - 92px);overflow:auto}
    textarea#editor{width:100%;height:36vh;min-height:160px;background:#07101a;color:var(--fg);border:1px solid rgba(255,255,255,0.03);padding:10px;box-sizing:border-box;font:inherit}
    .script .line{padding:6px 0;color:var(--fg)}
    #dbMeterTop{display:flex;gap:2px;height:14px;align-items:flex-end;position:relative;padding:0 2px;border:1px solid var(--edge);border-radius:4px;overflow:hidden;background:linear-gradient(90deg,#124,#124 5%,#135 5%,#135 20%,#145 20%,#145 40%,#254 40%,#352 60%,#542 80%,#731 90%,#921 95%,#b11);background-size:100% 100%;margin:0;}
    button.chip{border:0;background:transparent;color:var(--fg);cursor:pointer}
    @media (max-width:900px){.app{grid-template-columns:1fr;}.topbar{height:56px;padding:10px}}
    /* Extra tiny critical rules to stabilize first-paint for HUD and overlays */
    #hud-root{position:fixed;right:12px;top:12px;z-index:2147483630;pointer-events:none;min-width:140px}
    .overlay{display:flex}
    .overlay.hidden{display:none}
    .overlay .sheet{background:#07101a;color:var(--fg);border-radius:8px;padding:10px}
    button,select,input{font:inherit}
    /* Present mode: hide left panel and expand viewer */
    html.tp-present .panel{display:none !important}
    html.tp-present .app{grid-template-columns:1fr !important}
    /* Ensure toast container is visible to test harness (non-zero box) */
    #tp_toast_container{position:fixed;right:12px;top:12px;z-index:2147483630;pointer-events:none;min-width:1px;min-height:1px}
    /* Chip state colorization for toggles */
    .chip[data-state="open"], .chip[data-state="on"]{background:rgba(60,180,75,0.18)}
    .chip[data-state="closed"], .chip[data-state="off"]{background:var(--chip-bg)}
    /* Save chip states */
    #saveChip[data-state="saved"]{background:rgba(60,180,75,0.18)}
    #saveChip[data-state="dirty"]{background:rgba(234,179,8,0.22)}
    /* Dev-only controls hidden by default; shown only with ?dev=1 */
    .dev-only{display:none !important}
    html.dev1 .dev-only{display:inline-flex !important}
    /* Dev-only HUD stats: ASR HUD visible only in dev1 */
    #asrStatsHud{display:none !important}
    html.dev1 #asrStatsHud{display:block !important}
    /* Test aliases: keep clickable for headless smoke while visually hidden */
    .test-alias{position:fixed;left:0;top:0;width:1px;height:1px;opacity:0;z-index:2147483647;pointer-events:auto}
  </style>

  <!-- Single loader above handles module import; remove redundant inline dist loader in dev -->

  <!-- Build badge (dev only) -->
  <style>
    #anvil-build-label{display:none;position:fixed;left:8px;bottom:6px;padding:4px 8px;font:12px/1.2 system-ui,sans-serif;background:rgba(0,0,0,.65);color:#fff;border-radius:6px;z-index:2147483647;pointer-events:none}
    html.tp-dev #anvil-build-label{display:block}
    @media print{#anvil-build-label{display:none}}
    @media (max-width:420px){#anvil-build-label{font-size:11px;padding:3px 6px}}
  </style>

  <!-- (Optional, prod) Tight CSP once everything is settled
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' https://unpkg.com; connect-src 'self' http://192.168.1.200:4455 ws://192.168.1.200:4455;"/>
  -->
</head>

<body>
<!-- Toast container placeholder (ensures smoke harness can detect it even before modules load) -->
<div id="tp_toast_container" class="tp-toast-container"></div>
<!-- Safety bridge: guarantees OBS Test pill + basic Auto-scroll movement in CI/dev only -->
<script>
(function(){
  try {
    // Enable only for CI/dev: query/hash (?ci=1 or #ci or ?dev=1) or localStorage.tp_ci==='1'
    var url = String(location && location.href || '');
    var devOn = /(\?|#)(.*\bci=1\b|dev=1\b)/i.test(url) || (function(){try{return localStorage.getItem('tp_ci')==='1'}catch(e){return false}})();
    if (!devOn) return; // fully disabled in prod sessions

    if (window.__TP_SAFETY_BRIDGE) return; window.__TP_SAFETY_BRIDGE = '1.0';
    var q = function(s){ return document.querySelector(s); };
    var selTest = '#settingsObsTest,#obsTest,[data-action="obs-test"]';
    var selAuto = '#autoToggle,[data-action="auto-toggle"]';
    var selInc  = '#autoInc,[data-action="auto-inc"]';
    var selDec  = '#autoDec,[data-action="auto-dec"]';

    function ensurePill(btn){
      var pill = q('#obsStatusText,#obsStatus');
      if (!pill) { pill = document.createElement('span'); pill.id = 'obsStatusText'; pill.style.marginLeft = '8px'; btn.after(pill); }
      return pill;
    }
    function getViewer(){ return q('#viewer,[data-role="viewer"]') || document.scrollingElement || document.documentElement; }

  async function handler(e){
      try {
        var t = e && e.target && (e.target.closest ? e.target.closest(selTest+','+selAuto+','+selInc+','+selDec) : null);
        if (!t) return;
        // OBS Test connection
        if (t.matches && t.matches(selTest)) {
          if (e.cancelable) e.preventDefault(); if (e.stopImmediatePropagation) e.stopImmediatePropagation(); if (e.stopPropagation) e.stopPropagation();
          var pill = ensurePill(t); pill.textContent = 'testing…';
          try {
            var url  = (q('#settingsObsUrl,#obsUrl') && q('#settingsObsUrl,#obsUrl').value && q('#settingsObsUrl,#obsUrl').value.trim()) || 'ws://127.0.0.1:4455';
            var pass = (q('#settingsObsPassword,#obsPassword') && q('#settingsObsPassword,#obsPassword').value) || '';
            if (typeof window.__obsTestConnect === 'function') {
              var res = await window.__obsTestConnect(url, pass);
              var ver = (res && (res.version||res.obsWebSocketVersion||res.obsVersion)) || null;
              pill.textContent = ver ? ('connected ('+ver+')') : 'connected';
            } else {
              pill.textContent = 'failed: probe not loaded';
            }
          } catch (err) {
            pill.textContent = 'failed: ' + (err && (err.message||String(err)));
            try { console.warn('[OBS test failed]', err); } catch (e) {}
          }
          return;
        }
        // Auto toggle / speed fallback
        var btn = q(selAuto); if (!btn) return;
        if (e.cancelable) e.preventDefault(); if (e.stopImmediatePropagation) e.stopImmediatePropagation(); if (e.stopPropagation) e.stopPropagation();
        var step = (e.shiftKey ? 5 : 0.5);
        var isInc = !!(t.matches && t.matches(selInc));
        var isDec = !!(t.matches && t.matches(selDec));
        var isToggle = !!(t.matches && t.matches(selAuto));
        if (!isInc && !isDec && !isToggle) return;
        // Initialize defaults
        if (typeof window.__autoSpeed !== 'number' || !(window.__autoSpeed > 0)) window.__autoSpeed = 60;
        if (!btn.dataset.state) btn.dataset.state = 'off';
        // Apply action
        if (isInc) {
          window.__autoSpeed = Math.max(5, window.__autoSpeed + step);
        } else if (isDec) {
          window.__autoSpeed = Math.max(5, window.__autoSpeed - step);
        } else if (isToggle) {
          btn.dataset.state = (btn.dataset.state === 'on' ? 'off' : 'on');
        }
        var isOn = btn.dataset.state === 'on';
        var sFmt = (Math.round((Number(window.__autoSpeed)||0) * 10) / 10).toFixed(1);
        btn.textContent = isOn ? ('Auto-scroll: On — ' + sFmt + ' px/s') : 'Auto-scroll: Off';
        // Stop any previous fallback when toggling or when turning Off via speed buttons
        try { clearInterval(window.__autoFallbackTimer); } catch (e) {}
        window.__autoFallbackTimer = null;
        if (isOn) {
          try {
            if (window.__scrollCtl && typeof window.__scrollCtl.setSpeed === 'function') { window.__scrollCtl.setSpeed(window.__autoSpeed); }
            if (window.__scrollCtl && typeof window.__scrollCtl.start === 'function') { window.__scrollCtl.start(); }
          } catch (e) {}
          if (!(window.__scrollCtl && typeof window.__scrollCtl.setSpeed === 'function')) {
            var viewer = getViewer();
            // Immediate nudge to make movement detectable in short probes
            try { viewer.scrollTop += Math.max(1, window.__autoSpeed / 5); } catch (e) {}
            window.__autoFallbackTimer = setInterval(function(){
              try {
                // If the real engine becomes available, switch to it and stop fallback
                if (window.__scrollCtl && typeof window.__scrollCtl.start === 'function') {
                  try { clearInterval(window.__autoFallbackTimer); } catch (e) {}
                  window.__autoFallbackTimer = null;
                  try { window.__scrollCtl.setSpeed(window.__autoSpeed); } catch (e) {}
                  try { window.__scrollCtl.start(); } catch (e) {}
                  return;
                }
                viewer.scrollTop += window.__autoSpeed / 10;
              } catch (e) {}
            }, 100);
          }
        }
      } catch (e) {}
    }
    document.addEventListener('click', handler, true);
    document.addEventListener('click', handler, false);
  } catch (e) {}
})();
</script>
<div class="topbar">
<strong>Anvil - Teleprompter</strong>
<span id="appVersion" class="version-badge" aria-label="App version">v1.7.6</span>
  <span class="chip" id="saveChip">Draft: —</span>
  <span class="chip" id="permChip">Mic: unknown</span>
  <span class="chip" id="displayChip">Display: closed</span>
  <span class="chip" id="recChip" role="status" aria-live="polite" aria-atomic="true">Speech: idle</span>
  <!-- Mic level + calibration -->
  <div class="mic-block">
    <span class="topbar-label">Mic level</span>
  <div id="dbMeterTop" title="Input level"></div>
  <button id="micCalBtn" class="mic-cal-btn" type="button">Calibrate Mic</button>
</div>
<!-- Auto status chip (Hybrid/Auto state) -->
<span id="autoChip" class="chip" aria-live="polite" aria-atomic="true" title="Auto scroll status">Auto: Manual</span>
<!-- Right-side controls wrapper (ASR chip mounts here) -->
<div id="topbarRight" class="inl-1">
  <!-- ASR chip + button will mount here -->
    <button class="chip" id="presentBtn" data-action="present-toggle">Present Mode</button>
    <button class="chip" id="displayToggleBtn" data-action="display" data-ci="display-toggle" aria-haspopup="dialog" aria-expanded="false" title="Open or close the display window">Display</button>
    <button id="settingsBtn" class="chip" aria-haspopup="dialog" aria-expanded="false" data-action="settings-open">Settings</button>
    <button id="shortcutsBtn" class="chip" aria-haspopup="dialog" aria-expanded="false" data-action="help-open">Help</button>
    <button id="hudBtn" class="chip" data-action="hud-toggle">HUD</button>
  <span id="selfChecksChip" class="chip chip-muted dev-only">
    Self-checks: <strong id="selfChecksText">6/6 ✔</strong> <em>(click)</em>
  </span>
  
</div>
<nav class="page-tabs" id="pageTabs">
  <button class="page-tab is-active" data-page-tab="run" aria-selected="true">Run</button>
  <button class="page-tab" data-page-tab="scripts" aria-selected="false">Scripts</button>
  <button class="page-tab" data-page-tab="hud" aria-selected="false">HUD</button>
</nav>
<div class="legend" id="legend"></div>
</div>
<script>
  (function(){
    try {
      var btn = document.getElementById('micCalBtn');
      if (btn && !btn.dataset.wired) {
        btn.dataset.wired = '1';
        btn.addEventListener('click', function(){
          try {
            var calBtn = document.getElementById('asrCalibBtn');
            if (calBtn){ calBtn.click(); return; }
            if (window.showCalibModal) window.showCalibModal();
            var settingsBtn = document.getElementById('settingsBtn');
            if (settingsBtn) settingsBtn.click();
            setTimeout(function(){ try { document.getElementById('asrCalibBtn')?.click(); } catch(e){} }, 150);
          } catch(e){}
        });
      }
    } catch(e){}
  })();
</script>
<div class="app" data-page-panel="run">
<aside class="panel" id="sidebar">
<h2>Controls</h2>
<section class="mode-card" id="scrollModeCard">
  <div class="mode-card-head">
    <span class="mode-chip" aria-hidden="true">Scroll Mode</span>
    <span class="mode-pill" id="scrollModeStatus">Priority Control</span>
  </div>
  <label class="sr-only" for="scrollMode">Scroll Mode</label>
  <select id="scrollMode" aria-label="Scroll Mode" aria-describedby="scrollModeHelpText" aria-live="polite">
    <option value="timed">Timed</option>
    <option value="wpm">WPM</option>
    <option value="hybrid" selected>Hybrid</option>
    <option value="asr">ASR</option>
    <option value="step">Step</option>
    <option value="rehearsal">Rehearsal</option>
  </select>
  <script>
    (function(){
      try {
        var sel = document.getElementById('scrollMode');
        if (!sel) return;
        var saved = null;
        try {
          var ls = window.localStorage;
          if (ls) saved = ls.getItem('tp_scroll_mode') || ls.getItem('scrollMode');
        } catch {}
        if (!saved && window.__tpStore && typeof window.__tpStore.get === 'function') {
          try { saved = window.__tpStore.get('scrollMode'); } catch {}
        }
        if (!saved) return;
        saved = String(saved || '').trim().toLowerCase();
        if (!saved) return;
        if (!sel.querySelector('option[value="' + saved + '"]')) return;
        sel.value = saved;
      } catch {}
    })();
  </script>
  <p class="mode-hint" id="scrollModeHelpText">Hybrid follows speech automatically. Switch anytime to lock in manual, ASR, or rehearsal modes.</p>
</section>
<div class="row">
<button id="displayToggleBtn" class="chip" type="button" aria-pressed="false" data-action="display-toggle">Display: Closed</button>
</div>
<div class="row">
<button id="micToggleBtn" class="chip mic-idle" type="button">Request Mic</button>
<button disabled="" id="recBtn" class="btn-primary btn-start" data-action="start-speech">Start speech sync</button>
</div>
<div class="row">
  <label>Auto-scroll (px/s)
    <input id="autoSpeed" type="number" min="0" max="300" step="0.5" value="21"/>
  </label>
  <button id="autoDec" class="chip" title="–1 (Shift: –5)">–</button>
  <button id="autoInc" class="chip" title="+1 (Shift: +5)">+</button>
  <button id="autoToggle">Auto-scroll: Off</button>
</div>
<div class="row visually-hidden" id="wpmRow" aria-hidden="true">
  <label>Target WPM
    <input id="wpmTarget" type="number" min="60" max="260" step="5" value="150"/>
  </label>
  <span class="chip" id="wpmPx">≈ — px/s</span>
  
</div>
<!-- Hidden legacy mic device selector stub (kept for backward compatibility with older code paths) -->
<select id="micDeviceSel" class="select-md" hidden></select>
 <div class="row" id="sidebarMediaHint">
   <span class="chip sidebar-hint">Mic, devices & OBS now live under Settings ▶ Recording/Media</span>
 </div>
<!-- Add a visible, labeled OBS toggle in the sidebar for quick access -->
<div class="row obs-row">
  <label>
    <input type="checkbox" id="enableObs" />
    <span>Enable OBS</span>
  </label>
  <span class="chip obs-status" id="obsStatus" aria-live="polite">OBS: idle</span>
</div>
<!-- OBS controls & Mic device selector moved into Settings overlay -->
<h2 class="select-md" >Camera</h2>
<div class="row">
<button id="cameraToggleBtn" class="chip" type="button" aria-pressed="false" data-action="camera-toggle"><span class="cam-label">Camera: Off</span><span class="spinner" aria-hidden="true"></span></button>
<button id="startCam" data-action="start-camera" class="hidden" type="button" tabindex="-1" aria-hidden="true">Start Camera</button>
<button id="stopCam" data-action="stop-camera" class="hidden" type="button" tabindex="-1" aria-hidden="true">Stop Camera</button>
</div>
<div class="row">
<label>Size (%) <input id="camSize" max="60" min="15" step="1" type="number" value="28"/></label>
<label>Opacity <input id="camOpacity" max="100" min="20" step="5" type="number" value="100"/></label>
<label><input checked="" id="camMirror" type="checkbox"/> Mirror</label>
<button id="camPiP" data-action="pip">Picture-in-Picture</button>
</div>
<div class="row visually-hidden" id="typographyRow" aria-hidden="true">
<label>Font size <input id="fontSize" max="96" min="16" step="2" type="number" value="48"/></label>
<label>Line height <input id="lineHeight" max="2" min="1.1" step="0.05" type="number" value="1.35"/></label>
</div>
<div class="row">
  <button id="catchUpBtn" title="Jump the script to the current line">Catch Up</button>
  <span class="chip">(Instantly centers the active line)</span>
  </div>
<div class="row">
<label>Pre-roll (sec)
          <input id="preroll" max="10" min="0" step="1" type="number" value="3"/>
          <span id="recIndicator" class="rec-indicator hidden" title="Recording in progress">● REC</span>
</label>
</div>
<div class="row">
  <label>Match aggressiveness
    <select id="matchAggro" class="select-md">
      <option value="1">Conservative</option>
      <option value="2" selected>Normal</option>
      <option value="3">Aggressive</option>
      <option value="4">Aggressive live-read</option>
    </select>
  </label>
</div>
<div class="row">
  <label>Motion smoothness
    <select id="motionSmooth" class="select-md">
      <option value="stable">Stable</option>
      <option value="balanced" selected>Balanced</option>
      <option value="responsive">Responsive</option>
    </select>
  </label>
</div>
<div class="row">
<button id="resetBtn">Reset timer</button>
<div class="timer" id="timer">00:00.0</div>
</div>
<div class="row">
<button id="loadSample" data-action="load-sample">Load sample text</button>
<button id="normalizeTopBtn">Normalize</button>
<button id="clearText">Clear</button>
</div>
<!-- Sidebar quick Scripts select moved into Title row below -->
<h2 class="section-title">
  Speakers
  <button id="toggleSpeakers" class="chip btn-chip" aria-expanded="true" aria-controls="speakersBody" data-action="speakers-toggle" data-ci="speakers-toggle" title="Show or hide speaker controls">Hide</button>
</h2>

<div id="speakersBody" data-panel="speakers">
  <div class="row">
    <label>Name <input id="name-s1" type="text" placeholder="Speaker 1"></label>
    <label>Color <input id="color-s1" type="color" value="#60a5fa"></label>
    <button id="wrap-s1">Wrap ➜ S1</button>
  </div>
  <div class="row">
    <label>Name <input id="name-s2" type="text" placeholder="Speaker 2"></label>
    <label>Color <input id="color-s2" type="color" value="#facc15"></label>
    <button id="wrap-s2">Wrap ➜ S2</button>
  </div>
  <div class="row">
    <label>Name <input id="name-g1" type="text" placeholder="Guest 1"></label>
    <label>Color <input id="color-g1" type="color" value="#34d399"></label>
    <button id="wrap-g1">Wrap ➜ G1</button>
  </div>
  <div class="row">
    <label>Name <input id="name-g2" type="text" placeholder="Guest 2"></label>
    <label>Color <input id="color-g2" type="color" value="#f472b6"></label>
    <button id="wrap-g2">Wrap ➜ G2</button>
  </div>

  <div class="row toolbar">
    <button id="wrap-bold"><b>B</b></button>
    <button id="wrap-italic"><i>I</i></button>
    <button id="wrap-underline"><span class="u">U</span></button>
    <button id="wrap-note">Note</button>
    <button id="wrap-color">Color…</button>
    <button id="wrap-bg">BG…</button>
    <button id="autoTagBtn">Smart Tag</button>
    <span class="chip">(use tags like [s1]…[/s1], [color=#ff0]…[/color])</span>
  </div>
  <div class="row">
    <button id="speakersKeyBtn" data-action="speakers-key" class="chip">Key…</button>
    <input id="speakersKey" type="text" placeholder="Type a key for speaker toggle" />
  </div>
</div>
<div class="row">
<label>Format
  <select id="downloadFormat" class="select-sm">
    <option value="txt" selected>.txt</option>
    <option value="md">.md</option>
    <option value="rtf">.rtf</option>
    <option value="text">.text</option>
    <option value="docx" disabled>.docx (soon)</option>
  </select>
  </label>
<button id="downloadFile">Download</button>
<button id="uploadFileBtn" data-action="upload">Upload file</button>
<input id="uploadFile" type="file" accept=".txt,.md,.rtf,.text,.docx" hidden>
</div>
<!-- Scripts row: sidebar select for next-to-load + file ops; folder mapping lives in Settings → General -->
<div class="row">
  <label>Scripts
    <select id="scriptSelectSidebar" class="select-md" aria-label="Mapped folder scripts" aria-busy="true" data-settings-mirror="scriptSelect"></select>
  </label>
  <span class="chip sidebar-hint">Manage folder in Settings → General</span>
  <!-- Keep legacy title input hidden for compatibility with tests and legacy save paths -->
  <input id="scriptTitle" type="text" placeholder="Untitled" hidden />
  <button id="scriptSaveBtn">Save</button>
  <button id="scriptSaveAsBtn">Save As</button>
  <button id="scriptLoadBtn">Load</button>
  <button id="scriptDeleteBtn">Delete</button>
  <button id="scriptRenameBtn">Rename</button>
</div>
<div class="row">
<button id="resetScriptBtn">Reset Script</button>
</div>
<p class="status" id="status"></p>
<h2>Script</h2>
<textarea id="editor" data-editor placeholder="Use tags: [s1]…[/s1], [s2]…[/s2], [g1]…[/g1], [g2]…[/g2]. Inline: [b], [i], [u], [note], [color=red], [bg=#112233]"></textarea>
<!-- Injected fallback speakers toggle & key buttons (ensure binder selectors always resolve even before JS mutates visibility) -->
<!-- speakersToggleBtn already present as #toggleSpeakers; provide data-action alias without duplicate id -->
<button id="speakersToggleBtnAlias" data-action="speakers-toggle" class="hidden" type="button" aria-controls="speakersBody" hidden>Speakers</button>
<!-- speakersKeyBtn already exists; add alias element for binder multi-selector without duplicate id -->
<button id="speakersKeyBtnAlias" data-action="speakers-key" class="hidden" type="button" hidden>Focus Key</button>
<script>
  // Fallback wiring for speakers toggle (keeps panel usable even if main binder fails)
  (function(){
    try {
      var btn = document.getElementById('toggleSpeakers');
      var body = document.getElementById('speakersBody');
      if (!btn || !body || btn.dataset.inlineWired === '1') return;
      btn.dataset.inlineWired = '1';
      var KEY = 'tp_speakers_visible';
      var apply = function(vis){
        try {
          body.style.display = vis ? '' : 'none';
          btn.textContent = vis ? 'Hide' : 'Show';
          btn.setAttribute('aria-expanded', vis ? 'true' : 'false');
          try { localStorage.setItem(KEY, vis ? '1' : '0'); } catch(e){}
        } catch(e){}
      };
      var vis = true; try { vis = (localStorage.getItem(KEY) !== '0'); } catch(e){}
      apply(vis);
      btn.addEventListener('click', function(){
        apply(!(body.style.display === '' || body.style.display === 'block' || body.style.display === null));
      });
    } catch(e){}
  })();
</script>
<!-- Ensure help overlay root & settings overlay root exist early for binder wiring (already have #shortcutsOverlay & #settingsOverlay) -->
<!-- Camera preview fallback (binder expects #cameraPreview) already present later; duplicate guarded by ID uniqueness -->
<!-- cameraPreview already defined later with proper classes; avoid duplicate -->
<!-- (Removed legacy External Scripts + settings export/import UI: now injected into Settings overlay) -->
</aside>
<main class="viewer" id="viewer">
<div class="marker"></div>
<div class="script" id="script">
  
</div>
<div class="camWrap" id="camWrap">
<span id="camRecDot" class="cam-rec-dot hidden" title="Recording"></span>
<video autoplay="" id="camVideo" muted=""></video>
</div>
<!-- Hidden camera preview element used by PiP/mock flows -->
<video id="cameraPreview" muted class="cam-preview" autoplay hidden></video>
</main>
</div>
<!-- Pre-roll overlay (main window) -->
<div id="countOverlay" class="inl-7">
<div class="row" >
<div class="select-md" >Begin speaking in</div>
<div id="countNum" class="preroll-num" >3</div>
</div>
</div>
<!-- Near the end of <body> -->
<div id="shortcutsOverlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="shortcutsTitle" data-overlay="help">
  <div class="sheet">
    <header>
      <h3 id="shortcutsTitle">Shortcuts</h3>
  <button id="shortcutsClose" class="btn-chip" data-action="help-close">Close</button>
    </header>

    <div class="shortcuts-grid">
      <div><strong>Space</strong></div><div>Toggle Auto-scroll</div>
      <div><strong>↑ / ↓</strong></div><div>Adjust Auto-scroll speed (±1)</div>
      <div><strong>Shift + ↑ / ↓</strong></div><div>Adjust by ±5</div>
      <div><strong>Mouse-wheel on speed field</strong></div><div>±1 (Shift: ±5)</div>
      <div><strong>1 / 2 / 3 / 4</strong></div><div>Wrap with [s1]/[s2]/[g1]/[g2]</div>
      <div><strong>Shift + ?</strong></div><div>Open Help</div>
      <div><strong>Ctrl/Cmd + O</strong></div><div>Load selected script from mapped folder</div>
      <div><strong>Ctrl/Cmd + S</strong></div><div>Save</div>
      <div><strong>F2</strong></div><div>Rename selected script</div>
      <div><strong>Delete</strong></div><div>Delete selected script</div>
    </div>
    <!-- JS will inject the Tag Guide here, including the Normalize button -->
  </div>
</div>
<section class="page-panel" data-page-panel="scripts" hidden>
  <h2>Scripts</h2>
  <p>Script library view coming soon.</p>
</section>

<section class="page-panel" data-page-panel="hud" hidden>
  <h2>HUD / Diagnostics</h2>
  <p>HUD and advanced diagnostics will live here.</p>
</section>

<!-- Settings overlay (dynamic content: mic, camera, speakers, recorders) -->
<div id="settingsOverlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="settingsTitle" data-overlay="settings">
  <div class="sheet settings-sheet">
    <header class="sheet-head">
      <h3 id="settingsTitle" class="settings-title">Settings</h3>
  <button id="settingsClose" class="btn-chip" data-action="settings-close">Close</button>
    </header>
    <!-- Legacy tabs removed; TS builder handles tabs inside settingsBody -->
    <div id="settingsBody" class="settings-body"></div>
</div>
</div>
<!-- Dev helper scripts are imported from src/index.js in dev mode; no duplicate tags here -->

<!-- Build label -->
<div id="anvil-build-label">
  ANVIL build 2025-10-15 00:00 • baseline: mainframe • HUD wired
</div>

<!-- HUD mount -->
<div id="hud-root" data-role="hud-root"></div>

  <!-- Present Mode exit button (visible only in Present Mode) -->
  <button id="presentExitBtn" class="present-exit" type="button">Exit Present (Esc)</button>

  <!-- ASR bridge removed: logic now rides along inside the ASR module (index-hooks/asr.ts) -->

  
  
  <script>
    (function(){
      // Display & Camera toggle wiring for prod HTML: aligns with mic toggle UX
      try {
        var tog = document.getElementById('displayToggleBtn');
        if (tog) {
          var setState = function(open){
            try{
              tog.dataset.state = open ? 'open' : 'closed';
              tog.textContent = open ? 'Display: Open' : 'Display: Closed';
              tog.setAttribute('aria-pressed', open ? 'true' : 'false');
            }catch(e){}
          };
          setState(false);
          tog.addEventListener('click', function(){
            try{
              var isOpen = tog.dataset.state === 'open';
              if (isOpen) {
                try {
                  if (window.__tpDisplay && typeof window.__tpDisplay.closeDisplay === 'function') window.__tpDisplay.closeDisplay();
                  else if (window.__tpDisplayWindow && window.__tpDisplayWindow.close) window.__tpDisplayWindow.close();
                } catch(e) {}
                setState(false);
              } else {
                try {
                  if (window.__tpDisplay && typeof window.__tpDisplay.openDisplay === 'function') window.__tpDisplay.openDisplay();
                  else window.open('display.html', 'TeleprompterDisplay', 'width=1000,height=700');
                } catch(e) {}
                setState(true);
              }
            }catch(e){}
          });
          document.addEventListener('tp:display:opened', function(){ try{ setState(true); }catch(e){} });
          document.addEventListener('tp:display:closed', function(){ try{ setState(false); }catch(e){} });
        }
        var camTog = document.getElementById('cameraToggleBtn');
        if (camTog) {
          var setCam = function(on){
            try {
              camTog.dataset.state = on ? 'on' : 'off';
              var lab = camTog.querySelector('.cam-label');
              if (lab) lab.textContent = on ? 'Camera: On' : 'Camera: Off';
              else camTog.textContent = on ? 'Camera: On' : 'Camera: Off';
              camTog.setAttribute('aria-pressed', on ? 'true' : 'false');
            } catch(e){}
          };
          setCam(false);
          // Re-enable button helpers
          function clearBusy(){ try { camTog.disabled = false; camTog.classList.remove('busy'); } catch(e){} }
          document.addEventListener('tp:camera:started', clearBusy);
          document.addEventListener('tp:camera:error', clearBusy);
          document.addEventListener('tp:camera:stopped', clearBusy);
          camTog.addEventListener('click', function(){
            try {
              var isOn = camTog.dataset.state === 'on';
              var api = window.__tpCamera || window.__camApi;
              // Re-query alias buttons late so order of inline scripts doesn't matter
              var startBtnDyn = document.getElementById('startCamAlias') || document.getElementById('startCam') || document.querySelector('[data-action="start-camera"]');
              var stopBtnDyn  = document.getElementById('stopCamAlias')  || document.getElementById('stopCam')  || document.querySelector('[data-action="stop-camera"]');
              if (isOn) {
                var did = false;
                try { if (api && typeof api.stopCamera === 'function') { api.stopCamera(); did = true; } } catch(e){}
                if (!did && stopBtnDyn && typeof stopBtnDyn.click === 'function') stopBtnDyn.click();
                setCam(false);
              } else {
                // Busy state while starting
                try { camTog.disabled = true; camTog.classList.add('busy'); } catch(e){}
                var did2 = false;
                try { if (api && typeof api.startCamera === 'function') { api.startCamera(); did2 = true; } } catch(e){}
                if (!did2 && startBtnDyn && typeof startBtnDyn.click === 'function') startBtnDyn.click();
                setCam(true);
              }
            } catch(e){}
          });
          document.addEventListener('tp:camera:started', function(){ try { setCam(true); } catch(e){} });
          document.addEventListener('tp:camera:stopped', function(){ try { setCam(false); } catch(e){} });
        }
      } catch (e) {}
    })();
  </script>
  <!-- Hidden alias controls for camera actions to preserve binder hooks (since legacy start/stop buttons were removed) -->
  <button id="startCamAlias" data-action="start-camera" hidden type="button" tabindex="-1" aria-hidden="true"></button>
  <button id="stopCamAlias" data-action="stop-camera" hidden type="button" tabindex="-1" aria-hidden="true"></button>
  <!-- Test alias for legacy display selectors: clickable but visually hidden -->
  <button id="openDisplayBtn" class="test-alias" type="button" aria-hidden="true" tabindex="-1" title="alias-open">Open Display (alias)</button>
  <button id="closeDisplayBtn" class="test-alias" type="button" aria-hidden="true" tabindex="-1" title="alias-close">Close Display (alias)</button>
  <!-- Hidden alias to preserve #speakerIndexChip for test/binders, removed from visible topbar -->
  <span id="speakerIndexChip" class="test-alias" aria-hidden="true" tabindex="-1" title="alias-speakers">Speakers</span>
  <script>
    (function(){
      try{
        var openAlias = document.getElementById('openDisplayBtn');
        var closeAlias = document.getElementById('closeDisplayBtn');
        if (openAlias) openAlias.addEventListener('click', function(){ try{ if (window.__tpDisplay && typeof window.__tpDisplay.openDisplay==='function') window.__tpDisplay.openDisplay(); else window.open('display.html','TeleprompterDisplay','width=1000,height=700'); }catch(e){} });
        if (closeAlias) closeAlias.addEventListener('click', function(){ try{ if (window.__tpDisplay && typeof window.__tpDisplay.closeDisplay==='function') window.__tpDisplay.closeDisplay(); else if (window.__tpDisplayWindow && window.__tpDisplayWindow.close) window.__tpDisplayWindow.close(); }catch(e){} });
      }catch(e){}
    })();
  </script>
  <script>
    (function(){
      // Save status indicator wiring for #saveChip
      try {
        var saveChip = document.getElementById('saveChip');
        if (!saveChip) return;

        function setDirty(){
          try {
            saveChip.textContent = 'Draft: Modified';
            saveChip.setAttribute('data-state','dirty');
          } catch(e){}
        }

        function setSaved(){
          try {
            saveChip.textContent = 'Draft: Saved';
            saveChip.setAttribute('data-state','saved');
          } catch(e){}
        }

        // Initial state
        try { saveChip.textContent = 'Draft: —'; saveChip.removeAttribute('data-state'); } catch(e){}

        // Editor changes mark draft as modified
        try {
          var editor = document.getElementById('editor');
          if (editor){ editor.addEventListener('input', setDirty, {passive:true}); }
        } catch(e){}

        // Title edits also mark as modified
        try {
          var title = document.getElementById('scriptTitle');
          if (title){
            title.addEventListener('input', setDirty, {passive:true});
            title.addEventListener('change', setDirty, {passive:true});
          }
        } catch(e){}

        // After user clicks Save / Save As, show Saved state
        try {
          var saveBtn = document.getElementById('scriptSaveBtn');
          if (saveBtn){ saveBtn.addEventListener('click', function(){ setTimeout(setSaved, 0); }); }
        } catch(e){}
        try {
          var saveAsBtn = document.getElementById('scriptSaveAsBtn');
          if (saveAsBtn){ saveAsBtn.addEventListener('click', function(){ setTimeout(setSaved, 0); }); }
        } catch(e){}

        // If app dispatches a custom event upon successful save, reflect that as well
        try { window.addEventListener('tp:script:saved', function(){ setSaved(); }); } catch(e){}
      } catch(e){}
    })();
  </script>
  <script>
    (function(){
      function markPasswordField(el){
        try {
          if (el && el.getAttribute('autocomplete') !== 'current-password') {
            el.setAttribute('autocomplete', 'current-password');
          }
        } catch (err) {}
      }

      function applyPasswordAutocomplete(){
        try {
          ['settingsObsPassword','obsPassword'].forEach(function(id){
            var el = document.getElementById(id);
            if (el) markPasswordField(el);
          });
        } catch (err) {}
      }

      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        applyPasswordAutocomplete();
      } else {
        document.addEventListener('DOMContentLoaded', applyPasswordAutocomplete, { once: true });
      }
    })();
  </script>
  <script>
    (function(){
      try {
        var el = document.getElementById('aboutVersion');
        if (!el) return;
        var v = '';
        try { if (window.APP_VERSION) v = String(window.APP_VERSION); } catch (e) {}
        if (!v) {
          var av = document.getElementById('appVersion');
          if (av && av.textContent) v = av.textContent.trim();
        }
        if (v) el.textContent = v;
      } catch (e) {}
    })();
  </script>
</body>
</html>

