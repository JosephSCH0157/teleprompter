name: CI - checks

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  check:
    name: Lint, Types, Smoke, UI Crawl
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Lint (JS)
        run: npm run lint || true

      - name: Typecheck (TS)
        run: npx tsc -p . --noEmit

      - name: Run smoke (headless)
        id: smoke
        run: |
          set -eo pipefail
          node tools/teleprompter_e2e.js --runSmoke --stubObs --shimRecorder --headless --timeout=120000 | tee smoke.log

      - name: Extract smoke report
        if: always()
        run: |
          LINE=$(grep -F "[SMOKE-REPORT]" smoke.log || true)
          echo "REPORT_LINE<<EOF" >> $GITHUB_OUTPUT
          echo "$LINE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run UI crawl
        run: node tools/ui_crawl.js

      - name: Validate UI crawl
        run: node tools/validate_ui_crawl.js

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: runtime-artifacts
          path: |
            smoke.log
            tools/ui_crawl_report.json

      - name: Bundle size check (optional)
        run: |
          node -e "const fs=require('fs');const p='dist/app.js';if(!fs.existsSync(p)){console.log('No dist/app.js; skipping size check');process.exit(0)};const kb=Math.round(fs.statSync(p).size/1024);if(kb>500){console.error('Bundle too big:',kb,'KB');process.exit(1)}else{console.log('Bundle OK:',kb,'KB')}"
                with:
                  name: runtime-artifacts
                  path: |
                    smoke.log
                    tools/ui_crawl_report.json

              - name: Optional: bundle size check
                run: |
                  node -e "const fs=require('fs');const p='dist/app.js';if(!fs.existsSync(p)){console.log('No dist/app.js; skipping size check');process.exit(0)};const kb=Math.round(fs.statSync(p).size/1024);if(kb>500){console.error('Bundle too big:',kb,'KB');process.exit(1)}else{console.log('Bundle OK:',kb,'KB')}"

